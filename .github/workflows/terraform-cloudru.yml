name: Terraform Cloud.ru Infrastructure

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Terraform command to run'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

jobs:
  terraform:
    name: 'Terraform ${{ inputs.command }}'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.5.0"

    - name: Create backend.hcl from secret
      run: |
        echo "${{ secrets.CLOUDRU_TF_BACKEND_HCL }}" > terraform/backend.hcl

    - name: Create terraform.tfvars from secret
      run: |
        echo "${{ secrets.CLOUDRU_TFVARS }}" > terraform/terraform.tfvars
      # Ð•ÑÐ»Ð¸ ÑÐµÐºÑ€ÐµÑ‚ Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½, ÑÐ¾Ð·Ð´Ð°ÑÑ‚ÑÑ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ñ„Ð°Ð¹Ð»

    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Validate
      working-directory: terraform
      run: terraform validate

    - name: Terraform Format Check
      working-directory: terraform
      run: terraform fmt -check

    - name: Terraform Plan
      if: inputs.command == 'plan'
      working-directory: terraform
      run: |
        terraform plan -no-color -out=tfplan
        terraform show tfplan > plan.txt
      continue-on-error: true

    - name: Update Plan Comment
      if: inputs.command == 'plan'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const planOutput = fs.readFileSync('terraform/plan.txt', 'utf8');
          
          const body = `## Terraform Plan ðŸ“‹
          
          **Environment:** \`${{ inputs.environment }}\`
          **Command:** \`${{ inputs.command }}\`
          **Status:** âœ… Success
          
          <details>
          <summary>Show Plan Output</summary>
          
          \`\`\`
          ${planOutput}
          \`\`\`
          
          </details>
          
          ---
          *Executed by: @${{ github.actor }}*
          *Workflow: \`${{ github.workflow }}\`*`;

    - name: Terraform Apply
      if: inputs.command == 'apply'
      working-directory: terraform
      run: |
        terraform apply -auto-approve tfplan

    - name: Terraform Destroy
      if: inputs.command == 'destroy'
      working-directory: terraform
      run: |
        terraform destroy -auto-approve

    - name: Upload Plan Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan-${{ inputs.environment }}
        path: terraform/tfplan
        retention-days: 7
