name: Terraform Cloud.ru Plan

on:
  workflow_dispatch:
  push:
    paths:
      - "terraform/**"
      - ".github/workflows/infra-cloudru.yml"
  pull_request:
    paths:
      - "terraform/**"
      - ".github/workflows/infra-cloudru.yml"

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
      # noqa: reuse existing action reference
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - name: Write backend.hcl (from secret)
        if: ${{ secrets.CLOUDRU_TF_BACKEND_HCL != '' }}
        working-directory: terraform
        run: |
          cat <<'EOF' > backend.hcl
          ${{ secrets.CLOUDRU_TF_BACKEND_HCL }}
          EOF

      - name: Write terraform.tfvars (from secret)
        if: ${{ secrets.CLOUDRU_TFVARS != '' }}
        working-directory: terraform
        run: |
          cat <<'EOF' > terraform.tfvars
          ${{ secrets.CLOUDRU_TFVARS }}
          EOF

      - name: Terraform fmt
        working-directory: terraform
        run: terraform fmt -check

      - name: Terraform init
        working-directory: terraform
        run: |
          if [ -f backend.hcl ]; then
            terraform init -backend-config=backend.hcl
          else
            terraform init
          fi

      - name: Terraform validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform plan
        working-directory: terraform
        run: terraform plan -out=tfplan

      - name: Upload plan artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: terraform/tfplan

