# Документация проекта: AI Telegram Bot

## 1. Обзор проекта

**Цель:** Создать Telegram-бота, который использует базу знаний из PDF-документов для ответов на вопросы пользователей.

**Основные технологии:**
- **Язык:** Python 3.11
- **Оркестрация:** Docker, Docker Compose
- **База данных:** PostgreSQL с расширением `pgvector` для хранения векторных эмбеддингов.
- **LLM и Эмбеддинги:** YandexGPT API (для суммаризации, извлечения тем и создания эмбеддингов).
- **Взаимодействие с БД:** `asyncpg` для асинхронных операций.
- **Обработка документов:** `langchain` для загрузки и разделения PDF.

## 2. Архитектура и ключевые компоненты

Проект состоит из нескольких ключевых скриптов, работающих в Docker-контейнерах.

- **`docker-compose.yml`**: Определяет два сервиса: `db` (PostgreSQL) и `app` (Python-приложение).
- **`Dockerfile`**: Собирает образ для сервиса `app`, устанавливая все необходимые Python-зависимости.
- **`.env`**: Файл конфигурации для хранения секретов (токены, ключи API, URL базы данных).
- **`ingest.py`**: Скрипт для начальной загрузки и обработки данных. Он выполняет следующие шаги:
    1.  Читает PDF-файлы из директории `data_pdfs/`.
    2.  Разделяет их на небольшие текстовые чанки.
    3.  Для каждого документа извлекает краткое резюме и ключевые темы с помощью YandexGPT.
    4.  Для каждого чанка генерирует векторный эмбеддинг с помощью Yandex Text Embedding API.
    5.  Очищает таблицы `documents` и `knowledge_base_topics` и загружает в них новые данные.
- **`app.py`**: Основной скрипт, запускающий Telegram-бота (логика еще не реализована полностью).
- **`retriever.py`**: Модуль для взаимодействия с базой данных и Yandex API. Содержит функции для:
    -   Создания пула соединений с PostgreSQL (`asyncpg`).
    -   Генерации эмбеддингов для текстов (`embed_docs`, `embed_query`).
    -   Поиска релевантных документов в базе данных по векторной близости.
- **`llm.py`**: Модуль для взаимодействия с YandexGPT в режиме чата.

## 3. Важные технические решения

В ходе стабилизации скрипта `ingest.py` были приняты следующие решения:

1.  **Конфликт драйверов БД:** Была обнаружена проблема совместимости между `asyncpg` и `SQLAlchemy` (который неявно использовался библиотекой `PGVector`). `asyncpg` требует `DATABASE_URL` в формате `postgresql://...`, в то время как `SQLAlchemy` требовал `postgresql+psycopg2://...`.
    -   **Решение:** Отказаться от высокоуровневой функции `PGVector.from_embeddings` и реализовать ручную вставку данных в PostgreSQL с помощью `asyncpg`. Это унифицировало работу с базой данных и устранило конфликт.
2.  **Ошибка лимита токенов API:** YandexGPT API возвращал ошибку `400 Bad Request` из-за превышения максимального количества токенов во входных данных.
    -   **Решение:** Длина текста, отправляемого на суммаризацию и извлечение тем, была значительно сокращена. Введены консервативные ограничения на количество символов, чтобы избежать превышения лимита токенов.
3.  **Оптимизация Docker-сборки:** Сборка образа занимала много времени и прерывалась из-за копирования большого объема PDF-файлов в образ.
    -   **Решение:** Создан файл `.dockerignore`, чтобы исключить директорию `data_pdfs/` из контекста сборки. Вместо этого директория монтируется в контейнер как volume, что является лучшей практикой.
