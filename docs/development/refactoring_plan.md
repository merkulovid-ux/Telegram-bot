# План рефакторинга и верификации

Этот документ описывает критерии приемки (AC) и определение готовности (DoD) для каждого файла проекта.

## 1. `config.py`

- **AC 1:** Загружает переменные окружения из `.env` файла.
- **AC 2:** Импортирует и предоставляет переменные: `TELEGRAM_BOT_TOKEN`, `YANDEX_API_KEY`, `YC_FOLDER_ID`, `DATABASE_URL`.
- **AC 3:** Вызывает исключение `ValueError`, если какая-либо из переменных отсутствует.
- **DoD:** Файл существует, соответствует всем AC, не содержит лишнего кода.

## 2. `handlers/common.py`

- **AC 1:** Содержит обработчик команды `/start` (`CommandStart`).
- **AC 2:** Формирует приветственное сообщение, используя `message.from_user.full_name`.
- **AC 3:** Все HTML-теги в сообщении корректно экранированы (например, `&lt;` и `&gt;`).
- **AC 4:** Отправляет сообщение с `parse_mode='HTML'`.
- **DoD:** Файл существует, соответствует всем AC, не содержит других обработчиков.

## 3. `retriever.py`

- **AC 1:** Использует `asyncpg` для асинхронной работы с PostgreSQL.
- **AC 2:** Реализует и использует пул соединений (`connection pool`) для эффективного управления подключениями к БД.
- **AC 3:** Содержит асинхронные функции `embed_docs`, `embed_query`, `upsert_docs`, `search`.
- **AC 4:** Корректно импортирует `YANDEX_API_KEY`, `YC_FOLDER_ID`, `DATABASE_URL` из `config.py`.
- **AC 5:** В функции `search` использует параметризованный запрос с `LIMIT` для предотвращения SQL-инъекций и контроля количества результатов.
- **DoD:** Файл существует, соответствует всем AC, вся работа с БД инкапсулирована в этом модуле.

## 4. `llm.py`

- **AC 1:** Инициализирует клиент `OpenAI` для работы с API YandexGPT.
- **AC 2:** Корректно импортирует `YANDEX_API_KEY` и `YC_FOLDER_ID` из `config.py`.
- **AC 3:** Содержит функцию `chat`, которая принимает на вход список сообщений и параметры `temperature`, `max_tokens`.
- **AC 4:** Функция `chat` не является асинхронной, так как библиотека `openai` в синхронном варианте не требует `await`.
- **DoD:** Файл существует, соответствует всем AC, инкапсулирует всю логику взаимодействия с YandexGPT.

## 5. `handlers/llm_commands.py`

- **AC 1:** Содержит асинхронные обработчики для команд: `/ask`, `/digest`, `/retro`, `/nvc`, `/po_helper`, `/icebreaker`, `/swot`.
- **AC 2:** Корректно импортирует функции `chat` из `llm.py` и `search` из `retriever.py`.
- **AC 3:** Для команды `/ask` вызывает `search` для получения контекста, а затем `chat` для генерации ответа.
- **AC 4:** Для остальных команд формирует соответствующий системный промпт и вызывает `chat`.
- **AC 5:** Все обработчики корректно обрабатывают случай, когда пользователь не ввел данные после команды (например, `/ask` без вопроса).
- **DoD:** Файл существует, соответствует всем AC, содержит только обработчики LLM-команд.

## 6. `handlers/__init__.py`

- **AC 1:** Создает главный `Router`.
- **AC 2:** Импортирует роутеры из `handlers/common.py` и `handlers/llm_commands.py`.
- **AC 3:** Включает (регистрирует) импортированные роутеры в главный роутер.
- **DoD:** Файл существует, соответствует всем AC, служит для агрегации всех обработчиков.

## 7. `app.py`

- **AC 1:** Является точкой входа в приложение (`if __name__ == "__main__"`).
- **AC 2:** Содержит основную асинхронную функцию `main`.
- **AC 3:** В `main` инициализирует `Bot` и `Dispatcher`.
- **AC 4:** В `main` импортирует и регистрирует главный роутер из `handlers`.
- **AC 5:** В `main` инициализирует пул соединений с БД (`get_db_pool`) при старте и закрывает его при завершении работы.
- **AC 6:** Запускает `polling` с удалением "зависших" обновлений (`delete_webhook`).
- **DoD:** Файл существует, соответствует всем AC, не содержит логики обработки команд (она делегирована в `handlers`).

## 8. `ingest.py`

- **AC 1:** Является исполняемым скриптом (`if __name__ == '__main__'`).
- **AC 2:** Находит все файлы `.pdf`, `.epub`, `.fb2` в директории `data_pdfs/`.
- **AC 3:** Корректно извлекает текст из каждого типа файлов.
- **AC 4:** Разбивает извлеченный текст на фрагменты (чанки).
- **AC 5:** Для каждого чанка получает эмбеддинг через `embed_docs` из `retriever.py`.
- **AC 6:** Загружает все чанки и их эмбеддинги в БД через `upsert_docs` из `retriever.py`.
- **AC 7:** Корректно обрабатывает ошибки (например, пустые файлы) и закрывает пул соединений с БД после завершения работы.
- **DoD:** Файл существует, соответствует всем AC, предназначен для запуска вручную для загрузки данных.

## 9. `Dockerfile`

- **AC 1:** Использует `python:3.11-slim` как базовый образ.
- **AC 2:** Устанавливает рабочую директорию `/app`.
- **AC 3:** Копирует `requirements.txt` и устанавливает зависимости.
- **AC 4:** Копирует весь остальной код проекта (`COPY . .`).
- **AC 5:** Устанавливает переменные окружения `PYTHONIOENCODING=utf-8` и `PYTHONUTF8=1`.
- **AC 6:** Определяет команду по умолчанию `CMD ["python", "app.py"]`.
- **DoD:** Файл существует, соответствует всем AC, обеспечивает корректную сборку образа приложения.

## 10. `docker-compose.yml`

- **AC 1:** Определяет два сервиса: `db` и `app`.
- **AC 2:** Сервис `db` использует образ `pgvector/pgvector:pg16`.
- **AC 3:** Сервис `db` имеет корректные переменные окружения для PostgreSQL (`POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`).
- **AC 4:** Сервис `db` монтирует том `pgdata` для сохранения данных и пробрасывает порт `5432`.
- **AC 5:** Сервис `app` собирается из текущей директории (`build: .`).
- **AC 6:** Сервис `app` зависит от `db` (`depends_on: - db`).
- **AC 7:** Сервис `app` использует `.env` файл с хост-машины (`env_file: - .env`).
- **AC 8:** Сервис `app` монтирует локальную директорию `data_pdfs` в `/app/data_pdfs`.
- **AC 9:** Сервис `app` имеет команду по умолчанию `command: python app.py`.
- **AC 10:** Определен именованный том `pgdata`.
- **DoD:** Файл существует, соответствует всем AC, корректно оркестрирует работу `db` и `app`.

## 11. `requirements.txt`

- **AC 1:** Содержит все необходимые зависимости для работы бота: `aiogram`, `openai`, `pgvector`, `pypdf`, `python-dotenv`, `uvicorn`, `EbookLib`, `lxml`, `asyncpg`, `beautifulsoup4`.
- **DoD:** Файл существует, содержит только необходимые зависимости, каждая зависимость указана в новой строке.

## 12. `db_init.sql`

- **AC 1:** Создает расширение `vector`.
- **AC 2:** Создает таблицу `documents` со столбцами `id`, `source`, `loc`, `content`, `embedding`.
- **AC 3:** Столбец `embedding` имеет тип `VECTOR(256)`.
- **DoD:** Файл существует, содержит корректные SQL-команды для инициализации базы данных.

## 13. `.env`

- **AC 1:** Содержит переменную `TELEGRAM_BOT_TOKEN`.
- **AC 2:** Содержит переменную `YANDEX_API_KEY`.
- **AC 3:** Содержит переменную `YC_FOLDER_ID`.
- **AC 4:** Содержит переменную `DATABASE_URL` с корректным URL для подключения к `db` сервису Docker (`postgres://user:pass@db:5432/ai_bot`).
- **DoD:** Файл существует, содержит все необходимые переменные окружения.
