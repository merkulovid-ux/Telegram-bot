# Детальное руководство по получению учетных данных SberCloud

Это руководство предоставляет точные шаги по созданию сервисного аккаунта и ключей доступа в SberCloud (Cloud.ru), необходимых для дальнейшей автоматизации миграции.

## Необходимые учетные данные

Для программной работы с SberCloud мне нужен **файл с авторизованным ключом сервисного аккаунта**. Это JSON-файл, который содержит всю информацию для аутентификации от имени сервисного аккаунта.

## Шаг 1: Создание сервисного аккаунта

1.  **Войдите в личный кабинет SberCloud (Cloud.ru).**
2.  В меню слева выберите **"Проекты"** и перейдите в ваш проект.
3.  Внутри проекта, в меню слева, выберите **"Управление"** -> **"Пользователи и роли"**.
4.  Перейдите на вкладку **"Сервисные аккаунты"**.
5.  Нажмите **"Создать сервисный аккаунт"**.
6.  **Имя**: Введите `telegram-bot-admin-sa` (или другое имя, которое вы сможете легко идентифицировать).
7.  **Описание**: (Опционально) "Сервисный аккаунт для управления инфраструктурой Telegram-бота".
8.  Нажмите **"Создать"**.

## Шаг 2: Назначение ролей сервисному аккаунту

После создания сервисного аккаунта, ему необходимо предоставить права на управление ресурсами.

1.  На той же странице **"Сервисные аккаунты"** найдите созданный аккаунт и нажмите на него.
2.  Перейдите на вкладку **"Роли"**.
3.  Нажмите **"Назначить роли"**.
4.  В открывшемся окне выберите роль **`admin`** для вашего проекта. Это предоставит все необходимые права для создания и управления инфраструктурой (VPC, PostgreSQL, Object Storage, Container Apps, Vault, Artifact Registry).
    *   *Примечание: В будущем, для продакшн-среды, рекомендуется использовать более гранулярные роли для каждого сервиса, чтобы следовать принципу наименьших привилегий.*
5.  Нажмите **"Назначить"**.

## Шаг 3: Создание авторизованного ключа

1.  На странице вашего сервисного аккаунта (`telegram-bot-admin-sa`) перейдите на вкладку **"Ключи доступа"**.
2.  Нажмите **"Создать ключ"**.
3.  Выберите **"Создать авторизованный ключ"**.
4.  **Описание**: (Опционально) "Ключ для Terraform и CI/CD".
5.  Нажмите **"Создать"**.
6.  **Внимание!** Сразу после создания ключа появится окно с его содержимым (в формате JSON). **Скопируйте этот JSON или скачайте его, так как он больше не будет доступен для просмотра.**

## Шаг 4: Предоставление ключа для работы

1.  **Создайте файл**: В корневой директории нашего проекта (`C:\Users\U_M16X2\telegram-ai-bot`) создайте файл с именем `sbercloud-sa-key.json`.
2.  **Вставьте содержимое ключа**: Вставьте скопированный на предыдущем шаге JSON-ключ в этот файл.
3.  **Установите переменную окружения**: Откройте терминал и выполните следующую команду, чтобы я мог найти и использовать этот файл:
    ```powershell
    $env:YC_SERVICE_ACCOUNT_KEY_FILE="C:\Users\U_M16X2\telegram-ai-bot\sbercloud-sa-key.json"
    ```

После выполнения этих шагов я смогу аутентифицироваться в SberCloud и продолжить работу над задачами **BL-13** (Terraform) и **BL-12** (Lockbox).

## Шаг 5: Получение IAM-токена (CLI / автоматизация)

Для обращения к API Cloud.ru большинству сценариев нужен короткоживущий IAM-токен (TTL ~1 час), который запрашивается по `client_id` и `client_secret` сервисного аккаунта.

### Вариант 1 — curl (Windows PowerShell)

```powershell
curl.exe -i `
  --data-urlencode grant_type=access_key `
  --data-urlencode client_id=<CLIENT_ID> `
  --data-urlencode client_secret=<CLIENT_SECRET> `
  https://auth.iam.sbercloud.ru/auth/system/openid/token
```

- замените `<CLIENT_ID>` / `<CLIENT_SECRET>` значениями из JSON ключа (см. Шаг 3);
- вывод содержит `access_token`, `id_token`, `expires_in` — сохраняйте их в переменные окружения или Vault;
- **не** коммитьте реальные значения в репозиторий.

### Вариант 2 — Python-скрипт `scripts/get_cloudru_token.py`

1. Создайте `.env` с переменными `CLOUDRU_CLIENT_ID` и `CLOUDRU_CLIENT_SECRET` (или передайте флаги CLI).
2. Запустите:
   ```bash
   python scripts/get_cloudru_token.py --json
   ```
3. Скрипт использует `httpx`, выводит токены в JSON-формате и проверяет ошибки сети.

Токены стоит хранить в Vault/Lockbox и обновлять автоматически (например, GitHub Actions job). После получения токена запланируйте его ротацию и логирование событий (см. BL-18: Monitoring).

### Данные для Terraform модулей

После создания сервисного аккаунта и получения токенов, соберите следующие данные для работы Terraform (см. `terraform/README.md` и `docs/infra/SBERCLOUD_MIGRATION_PLAN.md`):

#### Обязательные данные Cloud.ru:
- **OBS бакет для state**: имя бакета (например, `telegram-ai-bot-tfstate`), endpoint (обычно `https://obs.ru-moscow-1.hc.sbercloud.ru`), access/secret keys сервисного аккаунта.
- **VPC/Subnet**: ID VPC, ID приватной подсети, CIDR подсети приложения (для security group rules).
- **Security Group**: ID security group для базы данных.
- **PostgreSQL**: желаемая версия (15), размер диска (100+ GB), имя админа (по умолчанию `pg_admin`), пароль (хранить в Vault!).

#### Подготовка секретов:
1. Создайте OBS-бакет вручную через Cloud.ru Console (или CLI).
2. Сохраните пароль PostgreSQL в Vault по пути `/v1/secret/data/pg_credentials` (ключ `password`).
3. Заполните `backend.hcl` и `terraform.tfvars` реальными значениями.
4. Загрузите их содержимое в GitHub Secrets как `CLOUDRU_TF_BACKEND_HCL` и `CLOUDRU_TFVARS`.

#### Следующие шаги:
- Запустите workflow `infra-cloudru.yml` (`workflow_dispatch`) для проверки `terraform plan`.
- Если нужны уточнения по API Cloud.ru, добавьте spike-задачи в `docs/process/BACKLOG.md`.

### Интеграция с GitHub Actions

- Добавьте в репозиторий секреты `CLOUDRU_TF_BACKEND_HCL` и `CLOUDRU_TFVARS`, чтобы workflow `.github/workflows/infra-cloudru.yml` мог выполнять `terraform plan`.
- Содержимое `CLOUDRU_TF_BACKEND_HCL` совпадает с рабочим `backend.hcl` (OBS-бакет, endpoint, ключи). `CLOUDRU_TFVARS` включает `sbercloud_access_key`, `sbercloud_secret_key`, `cloud_ru_region`, `environment`.
- Для ротации ключей обновляйте секреты и заново запускайте workflow (`workflow_dispatch`) — это подтвердит, что новые ключи валидны.
