{
  "cloud_build": {
    "predeploy": "python predeploy_check.py --env .env --env .env.prod",
    "tests": "pytest -q tests/test_smoke.py"
  },
  "deploy_spec": "apiVersion: deploy.yandex.cloud/v1\nkind: ExecutionSpec\nmetadata:\n  name: telegram-ai-bot\nspec:\n  containers:\n    - name: app\n      image: cr.yandex/<registry-id>/telegram-ai-bot:\n      concurrency: 1\n      memory: 1GiB\n      cores: 1\n      service-account-id: <runtime-service-account-id>\n      secrets:\n        - name: TELEGRAM_BOT_TOKEN\n          valueFrom:\n            secretId: <lockbox-secret-id>\n            key: TELEGRAM_BOT_TOKEN\n        - name: YC_API_KEY\n          valueFrom:\n            secretId: <lockbox-secret-id>\n            key: YC_API_KEY\n        - name: YC_OBS_ACCESS_KEY_ID\n          valueFrom:\n            secretId: <lockbox-secret-id>\n            key: YC_OBS_ACCESS_KEY_ID\n        - name: YC_OBS_SECRET_ACCESS_KEY\n          valueFrom:\n            secretId: <lockbox-secret-id>\n            key: YC_OBS_SECRET_ACCESS_KEY\n      env:\n        - name: DATABASE_URL\n          value: postgresql://user:pass@pg:5432/ai_bot\n        - name: YANDEX_FOLDER_ID\n          value: <folder-id>\n        - name: YC_SEARCH_INDEX_ID\n          value: <search-index-id>\n        - name: YC_ASSISTANT_ID\n          value: <assistant-id>\n  destination:\n    serverless-container:\n      id: <container-id>\n",
  "bootstrap_script": "#!/usr/bin/env python3\n\"\"\"Р“РµРЅРµСЂР°С‚РѕСЂ РєРѕРјР°РЅРґ РґР»СЏ РїРµСЂРІРёС‡РЅРѕР№ РЅР°СЃС‚СЂРѕР№РєРё YC РёРЅС„СЂР°СЃС‚СЂСѓРєС‚СѓСЂС‹.\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nfrom textwrap import dedent\n\n\ndef build_args() -> argparse.Namespace:\n    parser = argparse.ArgumentParser(description=__doc__)\n    parser.add_argument(\"--folder-id\", default=\"<folder-id>\")\n    parser.add_argument(\"--registry-id\", default=\"<registry-id>\")\n    parser.add_argument(\"--container-id\", default=\"<container-id>\")\n    parser.add_argument(\"--secret-id\", default=\"<lockbox-secret-id>\")\n    parser.add_argument(\"--runtime-sa\", default=\"telegram-runtime\")\n    parser.add_argument(\"--deploy-sa\", default=\"telegram-deploy\")\n    parser.add_argument(\"--build-sa\", default=\"telegram-build\")\n    parser.add_argument(\"--image-tag\", default=\"$BUILD_ID\")\n    return parser.parse_args()\n\n\ndef print_section(title: str, body: str) -> None:\n    line = \"=\" * len(title)\n    print(f\"\\n{title}\\n{line}\\n{body.strip()}\\n\")\n\n\ndef main() -> None:\n    args = build_args()\n    folder = args.folder_id\n    runtime = args.runtime_sa\n    deploy = args.deploy_sa\n    build = args.build_sa\n    registry = args.registry_id\n    secret = args.secret_id\n    tag = args.image_tag\n\n    print_section(\n        \"Service Accounts\",\n        dedent(\n            f\"\"\"\n            yc iam service-account create --name {runtime}\n            yc iam service-account create --name {deploy}\n            yc iam service-account create --name {build}\n\n            # РїРѕСЃР»Рµ СЃРѕР·РґР°РЅРёСЏ РїРѕРґСЃС‚Р°РІСЊС‚Рµ ID СЃРµСЂРІРёСЃРЅС‹С… Р°РєРєР°СѓРЅС‚РѕРІ РІРјРµСЃС‚Рѕ <*_sa_id>\n            yc resource-manager folder add-access-binding --id {folder} \\\n              --role serverless.containers.admin --subject serviceAccount:<runtime_sa_id>\n            yc resource-manager folder add-access-binding --id {folder} \\\n              --role lockbox.payloadViewer --subject serviceAccount:<runtime_sa_id>\n            yc resource-manager folder add-access-binding --id {folder} \\\n              --role deploy.editor --subject serviceAccount:<deploy_sa_id>\n            yc resource-manager folder add-access-binding --id {folder} \\\n              --role container-registry.pusher --subject serviceAccount:<deploy_sa_id>\n            yc resource-manager folder add-access-binding --id {folder} \\\n              --role cloud-build.builder --subject serviceAccount:<build_sa_id>\n            yc resource-manager folder add-access-binding --id {folder} \\\n              --role devtools.repo-reader --subject serviceAccount:<build_sa_id>\n            \"\"\"\n        ),\n    )\n\n    print_section(\n        \"Lockbox\",\n        dedent(\n            f\"\"\"\n            python export_lockbox_payload.py --env .env --env .env.prod --output secrets.json\n            yc lockbox secret create --name telegram-ai-bot --payload-file secrets.json\n            yc lockbox secret add-version --id {secret} --payload-file secrets.json\n            \"\"\"\n        ),\n    )\n\n    print_section(\n        \"Container Registry & Docker\",\n        dedent(\n            f\"\"\"\n            yc container registry create --name telegram-ai-registry\n            docker build -t cr.yandex/{registry}/telegram-ai-bot:{tag} .\n            docker push cr.yandex/{registry}/telegram-ai-bot:{tag}\n            \"\"\"\n        ),\n    )\n\n    print_section(\n        \"Cloud Deploy\",\n        dedent(\n            f\"\"\"\n            yc deploy release run \\\n              --spec deploy-spec.yaml \\\n              --service-account-id <deploy_sa_id> \\\n              --labels build_id={tag}\n\n            # Р»РёР±Рѕ РЅР°РїСЂСЏРјСѓСЋ\n            yc serverless container revision deploy \\\n              --container-id {args.container_id} \\\n              --image cr.yandex/{registry}/telegram-ai-bot:{tag} \\\n              --service-account-id <runtime_sa_id> \\\n              --secrets TELEGRAM_BOT_TOKEN={secret}:TELEGRAM_BOT_TOKEN\n            \"\"\"\n        ),\n    )\n\n    print_section(\n        \"Monitoring\",\n        dedent(\n            \"\"\"\n            python scripts/generate_alert_cli.py --spec monitoring_alerts.yaml \\\n              --var channel-id=<channel-id> \\\n              --var container-id=<container-id> \\\n              --var kb-diag-job-id=<job-id>\n            \"\"\"\n        ),\n    )\n\n\nif __name__ == \"__main__\":\n    main()\n",
  "setup_checklist": "# Yandex Cloud Infrastructure Setup\n\n## 1. Secrets and Lockbox\n1. Р­РєСЃРїРѕСЂС‚РёСЂСѓРµРј С‚РµРєСѓС‰РёРµ `.env` РґР°РЅРЅС‹Рµ РІ JSON:\n   ```bash\n   python export_lockbox_payload.py --env .env --env .env.prod --output secrets.json\n   ```\n2. РЎРѕР·РґР°С‘Рј СЃРµРєСЂРµС‚ Рё РїРµСЂРІСѓСЋ РІРµСЂСЃРёСЋ:\n   ```bash\n   yc lockbox secret create \\\n     --name telegram-ai-bot \\\n     --payload-file secrets.json \\\n     --description \"Secrets for Telegram AI Bot\"\n\n   yc lockbox secret add-version \\\n     --id <secret-id> \\\n     --payload-file secrets.json\n   ```\n3. Р’ `deploy-spec.yaml` Рё `yc serverless container revision deploy` РёСЃРїРѕР»СЊР·СѓРµРј РїР°СЂС‹ `<secret-id>:<key>`.\n\n## 2. Service Accounts and IAM roles\n| РќР°Р·РЅР°С‡РµРЅРёРµ | РљРѕРјР°РЅРґР° СЃРѕР·РґР°РЅРёСЏ | РћР±СЏР·Р°С‚РµР»СЊРЅС‹Рµ СЂРѕР»Рё |\n| --- | --- | --- |\n| Runtime (Serverless Container) | `yc iam service-account create --name telegram-runtime` | `serverless.containers.admin`, `lockbox.payloadViewer`, `vpc.user` (РµСЃР»Рё РЅСѓР¶РµРЅ РґРѕСЃС‚СѓРї Рє Р‘Р”) |\n| Deploy (Cloud Deploy/manual) | `yc iam service-account create --name telegram-deploy` | `deploy.editor`, `container-registry.pusher`, `lockbox.payloadViewer` |\n| Build (Cloud Build) | `yc iam service-account create --name telegram-build` | `cloud-build.builder`, `container-registry.pusher`, `devtools.repo-reader`, `lockbox.payloadViewer` |\n\nРџСЂРёРІСЏР·РєР° СЂРѕР»РµР№ Рє РїР°РїРєРµ `<folder-id>`:\n```bash\nyc resource-manager folder add-access-binding --id <folder-id> \\\n  --role serverless.containers.admin --subject serviceAccount:<runtime-sa-id>\nyc resource-manager folder add-access-binding --id <folder-id> \\\n  --role lockbox.payloadViewer --subject serviceAccount:<runtime-sa-id>\nyc resource-manager folder add-access-binding --id <folder-id> \\\n  --role deploy.editor --subject serviceAccount:<deploy-sa-id>\nyc resource-manager folder add-access-binding --id <folder-id> \\\n  --role container-registry.pusher --subject serviceAccount:<deploy-sa-id>\nyc resource-manager folder add-access-binding --id <folder-id> \\\n  --role cloud-build.builder --subject serviceAccount:<build-sa-id>\nyc resource-manager folder add-access-binding --id <folder-id> \\\n  --role devtools.repo-reader --subject serviceAccount:<build-sa-id>\n```\n\n## 3. Container Registry and Docker image\n```bash\nyc container registry create --name telegram-ai-registry\ndocker build -t cr.yandex/<registry-id>/telegram-ai-bot:${TAG} .\ndocker push cr.yandex/<registry-id>/telegram-ai-bot:${TAG}\n```\n`TAG` = `BUILD_ID` РёР· Cloud Build РёР»Рё СЂСѓС‡РЅРѕРµ Р·РЅР°С‡РµРЅРёРµ.\n\n## 4. DevTools Repo and Cloud Build\n1. РЎРѕР·РґР°С‘Рј СЂРµРїРѕР·РёС‚РѕСЂРёР№:\n   ```bash\n   yc devtools repo create --name telegram-ai-bot --description \"ProcessOff Telegram bot\"\n   git remote add yandex ssh://git@rc1c-<repo-id>.repo.cloud.yandex.net/telegram-ai-bot.git\n   git push yandex main\n   ```\n2. РќР°СЃС‚СЂР°РёРІР°РµРј Cloud Build С‚СЂРёРіРіРµСЂ:\n   ```bash\n   yc cloud-build trigger create git \\\n     --name telegram-ai-trigger \\\n     --repo-id <devtools-repo-id> \\\n     --branch main \\\n     --build-config-file .cloudbuild.yaml \\\n     --service-account-id <build-sa-id>\n   ```\n3. `.cloudbuild.yaml` РІРєР»СЋС‡Р°РµС‚:\n   - С€Р°Рі Python: `pip install`, `python predeploy_check.py --env .env --env .env.prod`, `pytest tests/test_smoke.py`;\n   - С€Р°Рі Docker: `docker build/push` РІ `cr.yandex/...`;\n   - С€Р°Рі Deploy: `yc deploy release run --spec deploy-spec.yaml --service-account-id <deploy-sa-id>`.\n\n## 5. Serverless Container Рё Deploy\n1. РџСЂРѕРІРµСЂСЏРµРј `deploy-spec.yaml`: РѕР±СЂР°Р· `cr.yandex/<registry-id>/telegram-ai-bot:<tag>`, `service-account-id: <runtime-sa-id>`, `secrets` СЃ Lockbox ID.\n2. Р СѓС‡РЅРѕР№ СЂРµР»РёР· (РµСЃР»Рё РЅСѓР¶РЅРѕ):\n   ```bash\n   yc deploy release run \\\n     --spec deploy-spec.yaml \\\n     --service-account-id <deploy-sa-id> \\\n     --labels build_id=${TAG} \\\n     --description \"deploy ${TAG}\"\n   ```\n3. РђР»СЊС‚РµСЂРЅР°С‚РёРІР° Р±РµР· Cloud Deploy:\n   ```bash\n   yc serverless container revision deploy \\\n     --container-id <container-id> \\\n     --image cr.yandex/<registry-id>/telegram-ai-bot:${TAG} \\\n     --service-account-id <runtime-sa-id> \\\n     --memory 1g --cores 1 \\\n     --env DATABASE_URL=postgresql://... \\\n     --secrets TELEGRAM_BOT_TOKEN=<secret-id>:TELEGRAM_BOT_TOKEN\n   ```\n\n## 6. Managed PostgreSQL Рё Object Storage\n- РЎРѕР·РґР°С‘Рј РїРµСЂРµРЅР°РїСЂР°РІР»РµРЅРёРµ VPC/SG Рё Managed PostgreSQL instance (`yc managed-postgresql cluster create ...`).\n- РћР±РЅРѕРІР»СЏРµРј `DATABASE_URL` РІ Lockbox / `.env.prod`.\n- Р—Р°РіСЂСѓР¶Р°РµРј РґРѕРєСѓРјРµРЅС‚С‹ РІ Object Storage `processoff-kb/knowledge-base/` Рё Р·Р°РїСѓСЃРєР°РµРј `python ingest_yc.py` в†’ `python create_assistant.py` (ID СЃРѕС…СЂР°РЅСЏРµРј РІ `.yc_*`).\n\n## 7. Automation and Monitoring\n1. Serverless Job РґР»СЏ `diag_connectivity.py` Рё ingestion cron (`Yandex_AUTOMATION.md`).\n2. Alerts Рё notification channels:\n   ```bash\n   python scripts/generate_alert_cli.py --spec monitoring_alerts.yaml \\\n     --var channel-id=<channel-id> \\\n     --var container-id=<container-id> \\\n     --var kb-diag-job-id=<job-id>\n   ```\n   Р’С‹РїРѕР»РЅРёС‚СЊ РєРѕРјР°РЅРґС‹ `yc monitoring notification-channel create ...` Рё `yc monitoring alert create ...`.\n3. РџСЂРѕРІРµСЂСЏРµРј `diag_report.md`, `monitoring_alerts.md` Рё РґР°С€Р±РѕСЂРґС‹.\n\n## 8. РћС‚РІРµС‚СЃС‚РІРµРЅРЅРѕСЃС‚СЊ СЂРѕР»РµР№\n- DevOps Engineer: С€Р°РіРё 1вЂ“7, РїРѕРґРґРµСЂР¶РєР° Lockbox/CI/CD.\n- QA Lead: РєРѕРЅС‚СЂРѕР»СЊ `predeploy_check.py`, `pytest`, smoke-С‚РµСЃС‚РѕРІ.\n- Scrum Master / Product Owner: РєРѕРѕСЂРґРёРЅР°С†РёСЏ РїРѕ BL-02 (Deployment Automation) Рё BL-03 (Monitoring), Р·Р°РїСѓСЃРє refinement/retro РїРѕ СЂРµРіР»Р°РјРµРЅС‚Сѓ README (refinement РєР°Р¶РґС‹Рµ 3 РѕС‚РІРµС‚Р°, СЂРµС‚СЂРѕ РєР°Р¶РґС‹Рµ 5).\n\n"
}